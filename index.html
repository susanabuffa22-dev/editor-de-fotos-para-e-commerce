<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Fotos E-commerce - Con Rate Limiting</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ====================
           ESTILOS COMPLETOS
           ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Alerta de Rate Limiting */
        .rate-limit-info {
            background: #fef3cd;
            border: 2px solid #f6e05e;
            color: #d69e2e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .rate-limit-info.warning {
            background: #fed7d7;
            border-color: #fc8181;
            color: #c53030;
        }

        .rate-limit-info.success {
            background: #c6f6d5;
            border-color: #68d391;
            color: #2f855a;
        }

        /* Modos */
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .mode-btn {
            padding: 18px 35px;
            border: 3px solid #e2e8f0;
            background: white;
            color: #64748b;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mode-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        .mode-btn:hover:not(.active) {
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        /* Cajas de contenido */
        .boxes-container {
            display: grid;
            gap: 25px;
            margin-bottom: 40px;
        }

        .mode-format .boxes-container {
            grid-template-columns: 1fr 1fr;
        }

        .mode-virtual .boxes-container {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .content-box {
            background: white;
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 25px;
            min-height: 350px;
            position: relative;
            transition: all 0.3s ease;
        }

        .content-box:hover {
            border-color: #94a3b8;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .content-box.has-image {
            border-color: #10b981;
            border-style: solid;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.2);
        }

        .box-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: #374151;
        }

        .box-label {
            position: absolute;
            top: -15px;
            left: 25px;
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* √Åreas de carga */
        .upload-area {
            text-align: center;
            cursor: pointer;
            padding: 50px 20px;
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8faff;
            transform: translateY(-2px);
        }

        .upload-area.has-file {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .upload-icon {
            width: 56px;
            height: 56px;
            margin-bottom: 20px;
            color: #94a3b8;
        }

        .upload-area.has-file .upload-icon {
            color: #10b981;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #64748b;
            margin: 8px 0;
            font-weight: 500;
        }

        .upload-hint {
            font-size: 0.95rem;
            color: #94a3b8;
        }

        .file-input {
            display: none;
        }

        /* Im√°genes */
        .image-display {
            width: 100%;
            height: 280px;
            border-radius: 12px;
            overflow: hidden;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-display img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }

        .placeholder-text {
            color: #94a3b8;
            font-size: 1.1rem;
            text-align: center;
            font-weight: 500;
        }

        /* Herramientas */
        .tools-section {
            background: #f8fafc;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
            border: 2px solid #e2e8f0;
        }

        .tools-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
            color: #374151;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .tool-btn {
            padding: 20px 25px;
            border: 3px solid #e2e8f0;
            background: white;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .tool-btn:hover:not(:disabled) {
            border-color: #667eea;
            background: #f8faff;
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .tool-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f1f5f9;
            transform: none;
            box-shadow: none;
        }

        .tool-btn:not(:disabled) {
            border-color: #10b981;
            background: #10b981;
            color: white;
        }

        /* Loading mejorado */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 40px;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e2e8f0;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #64748b;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .loading-info {
            color: #94a3b8;
            font-size: 0.9rem;
            font-style: italic;
        }

        /* Descarga */
        .download-section {
            text-align: center;
            padding: 30px;
            background: #f8fafc;
            border-radius: 16px;
            border: 2px solid #e2e8f0;
        }

        .download-btn {
            padding: 18px 45px;
            background: #059669;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .download-btn:hover:not(:disabled) {
            background: #047857;
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.4);
        }

        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #94a3b8;
            transform: none;
            box-shadow: none;
        }

        /* Mensajes mejorados */
        .error-message, .success-message {
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-weight: 500;
            text-align: center;
        }

        .error-message {
            background: #fef2f2;
            border: 2px solid #fecaca;
            color: #dc2626;
            display: none;
        }

        .success-message {
            background: #f0fdf4;
            border: 2px solid #bbf7d0;
            color: #166534;
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mode-format .boxes-container,
            .mode-virtual .boxes-container {
                grid-template-columns: 1fr;
            }

            .tools-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .app-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>Editor de Fotos E-commerce</h1>
            <p>Herramientas profesionales con manejo inteligente de l√≠mites de API</p>
        </header>

        <!-- Alerta de Rate Limiting -->
        <div class="rate-limit-info" id="rateLimitInfo">
            üöÄ <strong>Rate Limiting Activo:</strong> Las peticiones se procesan secuencialmente para evitar errores 429
        </div>

        <!-- Selector de Modo -->
        <div class="mode-selector">
            <button class="mode-btn active" id="mode-format">
                <span>üìê</span>
                <span>Formato/Fondo</span>
            </button>
            <button class="mode-btn" id="mode-virtual">
                <span>üëó</span>
                <span>Poner Ropa</span>
            </button>
        </div>

        <!-- Modo Formato/Fondo -->
        <div class="mode-format" id="mode-format-content">
            <div class="boxes-container">
                <!-- Caja 1: Subir Imagen -->
                <div class="content-box">
                    <div class="box-label">ENTRADA</div>
                    <h3 class="box-title">Subir Imagen Original</h3>
                    <div class="upload-area" id="format-upload-area">
                        <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        <p class="upload-text">Haz clic o arrastra tu imagen aqu√≠</p>
                        <p class="upload-hint">JPG, PNG hasta 10MB</p>
                    </div>
                    <input type="file" class="file-input" id="format-file-input" accept="image/*">
                    <div class="image-display" id="format-image-display" style="display: none;">
                        <img id="format-image" alt="Imagen original">
                    </div>
                </div>

                <!-- Caja 2: Resultado -->
                <div class="content-box">
                    <div class="box-label">RESULTADO</div>
                    <h3 class="box-title">Imagen Procesada</h3>
                    <div class="image-display" id="format-result-display">
                        <p class="placeholder-text">Aqu√≠ aparecer√° el resultado</p>
                    </div>
                </div>
            </div>

            <!-- Herramientas -->
            <div class="tools-section">
                <h3 class="tools-title">Selecciona la Transformaci√≥n</h3>
                <div class="tools-grid">
                    <button class="tool-btn" id="btn-white-bg" data-action="fondo-blanco" disabled>
                        <span>‚ö™</span>
                        <span>Fondo Blanco</span>
                    </button>
                    <button class="tool-btn" id="btn-square-format" data-action="formato-cuadrado" disabled>
                        <span>üìê</span>
                        <span>Formato Cuadrado</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modo Poner Ropa -->
        <div class="mode-virtual" id="mode-virtual-content" style="display: none;">
            <div class="boxes-container">
                <!-- Caja 1: Persona -->
                <div class="content-box">
                    <div class="box-label">PERSONA</div>
                    <h3 class="box-title">Subir Foto de Persona</h3>
                    <div class="upload-area" id="person-upload-area">
                        <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        <p class="upload-text">Haz clic o arrastra la foto aqu√≠</p>
                        <p class="upload-hint">Foto frontal de la persona</p>
                    </div>
                    <input type="file" class="file-input" id="person-file-input" accept="image/*">
                    <div class="image-display" id="person-image-display" style="display: none;">
                        <img id="person-image" alt="Foto de persona">
                    </div>
                </div>

                <!-- Caja 2: Prenda -->
                <div class="content-box">
                    <div class="box-label">PRENDA</div>
                    <h3 class="box-title">Subir Prenda</h3>
                    <div class="upload-area" id="garment-upload-area">
                        <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        <p class="upload-text">Haz clic o arrastra la prenda aqu√≠</p>
                        <p class="upload-hint">Ropa, accesorios, etc.</p>
                    </div>
                    <input type="file" class="file-input" id="garment-file-input" accept="image/*">
                    <div class="image-display" id="garment-image-display" style="display: none;">
                        <img id="garment-image" alt="Prenda">
                    </div>
                </div>

                <!-- Caja 3: Resultado -->
                <div class="content-box">
                    <div class="box-label">RESULTADO</div>
                    <h3 class="box-title">Virtual Try-On</h3>
                    <div class="image-display" id="virtual-result-display">
                        <p class="placeholder-text">Aqu√≠ aparecer√° el resultado del try-on</p>
                    </div>
                </div>
            </div>

            <!-- Herramientas -->
            <div class="tools-section">
                <h3 class="tools-title">Generar Virtual Try-On</h3>
                <div class="tools-grid">
                    <button class="tool-btn" id="btn-virtual-try-on" data-action="virtual-try-on" disabled>
                        <span>üëó</span>
                        <span>Procesar Virtual Try-On</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mensajes -->
        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>

        <!-- Descarga -->
        <div class="download-section">
            <button class="download-btn" id="download-btn" disabled>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Descargar Imagen Editada
            </button>
        </div>
    </div>

    <script>
        // ===========================
        // EDITOR CON RATE LIMITING
        // ===========================
        
        // Configuraci√≥n API
        var API_KEY = 'AIzaSyBAuTlMG2kQWBIpaylzCUhGJopB2JcNh6I';
        var API_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=' + API_KEY;

        // Estados globales
        var currentMode = 'format';
        var formatImageData = null;
        var personImageData = null;
        var garmentImageData = null;
        var processedImageData = null;
        var isProcessing = false;
        var requestQueue = [];
        var isProcessingQueue = false;
        var requestDelay = 2000; // 2 segundos entre peticiones
        var lastRequestTime = 0;

        // Elementos DOM
        var elements = {};

        // ===========================
        // INICIALIZACI√ìN
        // ===========================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Editor Simplificado con Rate Limiting');
            
            // Ocultar mensajes de API
            hideApiMessages();
            
            // Inicializar elementos
            initializeElements();
            
            // Configurar eventos
            setupEventListeners();
            
            // Configurar modo inicial
            switchMode('format');
            
            console.log('‚úÖ Editor listo para usar');
        });

        // ===========================
        // FUNCIONES DE INICIALIZACI√ìN
        // ===========================
        function initializeElements() {
            // Modos
            elements.modeFormat = document.getElementById('mode-format');
            elements.modeVirtual = document.getElementById('mode-virtual');
            elements.modeFormatContent = document.getElementById('mode-format-content');
            elements.modeVirtualContent = document.getElementById('mode-virtual-content');
            
            // Modo Formato
            elements.formatUploadArea = document.getElementById('format-upload-area');
            elements.formatFileInput = document.getElementById('format-file-input');
            elements.formatImageDisplay = document.getElementById('format-image-display');
            elements.formatImage = document.getElementById('format-image');
            elements.formatResultDisplay = document.getElementById('format-result-display');
            
            // Modo Virtual
            elements.personUploadArea = document.getElementById('person-upload-area');
            elements.personFileInput = document.getElementById('person-file-input');
            elements.personImageDisplay = document.getElementById('person-image-display');
            elements.personImage = document.getElementById('person-image');
            
            elements.garmentUploadArea = document.getElementById('garment-upload-area');
            elements.garmentFileInput = document.getElementById('garment-file-input');
            elements.garmentImageDisplay = document.getElementById('garment-image-display');
            elements.garmentImage = document.getElementById('garment-image');
            
            elements.virtualResultDisplay = document.getElementById('virtual-result-display');
            
            // Herramientas
            elements.btnWhiteBg = document.getElementById('btn-white-bg');
            elements.btnSquareFormat = document.getElementById('btn-square-format');
            elements.btnVirtualTryOn = document.getElementById('btn-virtual-try-on');
            
            // Acciones
            elements.downloadBtn = document.getElementById('download-btn');
            elements.errorMessage = document.getElementById('error-message');
            elements.successMessage = document.getElementById('success-message');
            elements.rateLimitInfo = document.getElementById('rateLimitInfo');
        }

        function setupEventListeners() {
            // Cambio de modo
            elements.modeFormat.addEventListener('click', function() {
                switchMode('format');
            });
            
            elements.modeVirtual.addEventListener('click', function() {
                switchMode('virtual');
            });
            
            // Carga de archivos - Modo Formato
            setupFileUpload(elements.formatUploadArea, elements.formatFileInput, function(file) {
                loadImage('format', file);
            });
            
            // Carga de archivos - Modo Virtual
            setupFileUpload(elements.personUploadArea, elements.personFileInput, function(file) {
                loadImage('person', file);
            });
            
            setupFileUpload(elements.garmentUploadArea, elements.garmentFileInput, function(file) {
                loadImage('garment', file);
            });
            
            // Herramientas
            elements.btnWhiteBg.addEventListener('click', function() {
                processImage('fondo-blanco');
            });
            
            elements.btnSquareFormat.addEventListener('click', function() {
                processImage('formato-cuadrado');
            });
            
            elements.btnVirtualTryOn.addEventListener('click', function() {
                processImage('virtual-try-on');
            });
            
            // Descarga
            elements.downloadBtn.addEventListener('click', function() {
                downloadImage();
            });
        }

        // ===========================
        // GESTI√ìN DE ARCHIVOS
        // ===========================
        function setupFileUpload(uploadArea, fileInput, callback) {
            // Click para seleccionar archivo
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('has-file');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('has-file');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('has-file');
                
                var files = e.dataTransfer.files;
                if (files.length > 0) {
                    callback(files[0]);
                }
            });
            
            // Archivo seleccionado
            fileInput.addEventListener('change', function(e) {
                var files = e.target.files;
                if (files.length > 0) {
                    callback(files[0]);
                }
            });
        }

        function loadImage(type, file) {
            if (!file.type.match('image.*')) {
                showError('Por favor selecciona un archivo de imagen v√°lido (JPG, PNG)');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showError('El archivo es demasiado grande. M√°ximo 10MB permitido.');
                return;
            }
            
            var reader = new FileReader();
            
            reader.onload = function(e) {
                var imageData = e.target.result;
                
                // Almacenar data
                if (type === 'format') {
                    formatImageData = imageData;
                    showImage(elements.formatImageDisplay, elements.formatImage, imageData);
                    updateFormatTools();
                } else if (type === 'person') {
                    personImageData = imageData;
                    showImage(elements.personImageDisplay, elements.personImage, imageData);
                    updateVirtualTools();
                } else if (type === 'garment') {
                    garmentImageData = imageData;
                    showImage(elements.garmentImageDisplay, elements.garmentImage, imageData);
                    updateVirtualTools();
                }
                
                showSuccess('Imagen cargada correctamente');
            };
            
            reader.onerror = function() {
                showError('Error al cargar la imagen');
            };
            
            reader.readAsDataURL(file);
        }

        function showImage(container, img, data) {
            container.style.display = 'block';
            img.src = data;
            container.parentElement.classList.add('has-image');
        }

        // ===========================
        // GESTI√ìN DE MODOS
        // ===========================
        function switchMode(mode) {
            currentMode = mode;
            
            // Actualizar botones de modo
            elements.modeFormat.classList.remove('active');
            elements.modeVirtual.classList.remove('active');
            
            if (mode === 'format') {
                elements.modeFormat.classList.add('active');
                elements.modeFormatContent.style.display = 'block';
                elements.modeVirtualContent.style.display = 'none';
                updateFormatTools();
            } else if (mode === 'virtual') {
                elements.modeVirtual.classList.add('active');
                elements.modeFormatContent.style.display = 'none';
                elements.modeVirtualContent.style.display = 'block';
                updateVirtualTools();
            }
            
            hideMessages();
            console.log('üîÑ Modo cambiado a:', mode);
        }

        // ===========================
        // HABILITACI√ìN DE HERRAMIENTAS
        // ===========================
        function updateFormatTools() {
            var enabled = formatImageData !== null;
            elements.btnWhiteBg.disabled = !enabled;
            elements.btnSquareFormat.disabled = !enabled;
        }

        function updateVirtualTools() {
            var enabled = personImageData !== null && garmentImageData !== null;
            elements.btnVirtualTryOn.disabled = !enabled;
        }

        // ===========================
        // PROCESAMIENTO CON RATE LIMITING
        // ===========================
        function processImage(action) {
            if (isProcessing) {
                showError('Ya hay un procesamiento en curso. Por favor espera.');
                return;
            }
            
            var imageData = null;
            var prompt = '';
            var resultDisplay = null;
            
            // Preparar datos seg√∫n la acci√≥n
            if (action === 'fondo-blanco' || action === 'formato-cuadrado') {
                if (!formatImageData) {
                    showError('Por favor carga una imagen primero');
                    return;
                }
                imageData = formatImageData;
                resultDisplay = elements.formatResultDisplay;
                
                if (action === 'fondo-blanco') {
                    prompt = 'Cambia el fondo de esta imagen por un fondo blanco limpio y profesional, manteniendo la calidad de la imagen original';
                } else if (action === 'formato-cuadrado') {
                    prompt = 'Convierte esta imagen a formato cuadrado manteniendo la calidad y la composici√≥n original, adaptando el tama√±o a 1:1';
                }
            } else if (action === 'virtual-try-on') {
                if (!personImageData || !garmentImageData) {
                    showError('Por favor carga tanto la persona como la prenda');
                    return;
                }
                imageData = personImageData;
                resultDisplay = elements.virtualResultDisplay;
                prompt = 'Combina esta imagen de persona con la prenda que se le superponga de manera natural y realista. La prenda debe verse como si la persona la estuviera usando realmente. Mant√©n la calidad fotorreal√≠stica.';
            }
            
            // Mostrar loading
            showLoading(resultDisplay);
            isProcessing = true;
            
            // Agregar a la cola con rate limiting
            addToQueue(function() {
                return sendToAPI(imageData, prompt);
            }, function(response) {
                hideLoading(resultDisplay);
                isProcessing = false;
                
                if (response.success && response.imageData) {
                    processedImageData = response.imageData;
                    showProcessedImage(resultDisplay, response.imageData);
                    elements.downloadBtn.disabled = false;
                    showSuccess('Imagen procesada correctamente');
                } else {
                    showError(response.error || 'Error al procesar la imagen');
                }
            }, function(error) {
                hideLoading(resultDisplay);
                isProcessing = false;
                handleAPIError(error, action);
            });
        }

        function addToQueue(requestFunction, successCallback, errorCallback) {
            var requestItem = {
                request: requestFunction,
                success: successCallback,
                error: errorCallback
            };
            
            requestQueue.push(requestItem);
            
            if (!isProcessingQueue) {
                processQueue();
            }
        }

        function processQueue() {
            if (requestQueue.length === 0) {
                isProcessingQueue = false;
                return;
            }
            
            isProcessingQueue = true;
            var currentRequest = requestQueue.shift();
            
            // Calcular delay necesario
            var now = Date.now();
            var timeSinceLastRequest = now - lastRequestTime;
            var delay = Math.max(0, requestDelay - timeSinceLastRequest);
            
            setTimeout(function() {
                currentRequest.request()
                    .then(function(response) {
                        lastRequestTime = Date.now();
                        currentRequest.success(response);
                        processQueue();
                    })
                    .catch(function(error) {
                        lastRequestTime = Date.now();
                        currentRequest.error(error);
                        processQueue();
                    });
            }, delay);
        }

        function showLoading(container) {
            var loading = document.createElement('div');
            loading.className = 'loading';
            loading.id = 'current-loading';
            
            var spinner = document.createElement('div');
            spinner.className = 'spinner';
            
            var text = document.createElement('p');
            text.className = 'loading-text';
            text.textContent = 'Procesando imagen...';
            
            var info = document.createElement('p');
            info.className = 'loading-info';
            info.textContent = 'Las peticiones se procesan secuencialmente para evitar errores 429';
            
            loading.appendChild(spinner);
            loading.appendChild(text);
            loading.appendChild(info);
            
            container.innerHTML = '';
            container.appendChild(loading);
        }

        function hideLoading(container) {
            var loading = container.querySelector('#current-loading');
            if (loading) {
                container.removeChild(loading);
            }
        }

        function showProcessedImage(container, imageData) {
            var img = document.createElement('img');
            img.src = imageData;
            img.alt = 'Imagen procesada';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '100%';
            img.style.objectFit = 'contain';
            img.style.borderRadius = '8px';
            
            container.innerHTML = '';
            container.appendChild(img);
        }

        // ===========================
        // COMUNICACI√ìN CON API CON MANEJO DE ERRORES
        // ===========================
        function sendToAPI(imageData, prompt) {
            return new Promise(function(resolve, reject) {
                try {
                    // Crear request
                    var requestData = {
                        contents: [{
                            parts: [
                                {
                                    text: prompt
                                },
                                {
                                    inline_data: {
                                        mime_type: 'image/jpeg',
                                        data: imageData.split(',')[1]
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 2048
                        }
                    };
                    
                    // XMLHttpRequest para compatibilidad CSP
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', API_ENDPOINT, true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                var response = JSON.parse(xhr.responseText);
                                var result = handleAPIResponse(response);
                                if (result.success) {
                                    resolve(result);
                                } else {
                                    reject(result.error);
                                }
                            } catch (e) {
                                reject('Error de respuesta: ' + e.message);
                            }
                        } else if (xhr.status === 429) {
                            reject('rate_limit_exceeded');
                        } else if (xhr.status === 403) {
                            reject('api_quota_exceeded');
                        } else {
                            reject('Error HTTP: ' + xhr.status);
                        }
                    };
                    
                    xhr.onerror = function() {
                        reject('Error de red');
                    };
                    
                    xhr.timeout = 45000;
                    xhr.ontimeout = function() {
                        reject('Timeout: La solicitud tom√≥ demasiado tiempo');
                    };
                    
                    xhr.send(JSON.stringify(requestData));
                    
                } catch (e) {
                    reject('Error: ' + e.message);
                }
            });
        }

        function handleAPIResponse(response) {
            try {
                if (response.candidates && response.candidates.length > 0) {
                    var candidate = response.candidates[0];
                    
                    if (candidate.content && candidate.content.parts) {
                        var parts = candidate.content.parts;
                        
                        for (var i = 0; i < parts.length; i++) {
                            var part = parts[i];
                            
                            if (part.inlineData) {
                                return {
                                    success: true,
                                    imageData: 'data:image/jpeg;base64,' + part.inlineData.data
                                };
                            }
                        }
                    }
                }
                
                return {
                    success: false,
                    error: 'No se encontr√≥ imagen en la respuesta'
                };
                
            } catch (e) {
                return {
                    success: false,
                    error: 'Error procesando respuesta: ' + e.message
                };
            }
        }

        function handleAPIError(error, action) {
            if (error === 'rate_limit_exceeded') {
                showRateLimitWarning();
                
                // Aumentar el delay temporalmente
                requestDelay = 5000;
                
                setTimeout(function() {
                    showSuccess('Sistema de rate limiting activado. Las peticiones ahora se procesan con mayor espaciado.');
                    requestDelay = 2000;
                }, 3000);
                
            } else if (error === 'api_quota_exceeded') {
                showError('‚ùå Has excedido la cuota diaria de la API. Por favor espera hasta ma√±ana o actualiza la cuota en Google Cloud Console.');
            } else if (error.includes('Timeout')) {
                showError('‚è∞ La imagen es muy compleja. Intenta con una imagen m√°s peque√±a o espera unos minutos.');
            } else if (error.includes('Error de red')) {
                showError('üåê Error de conexi√≥n. Verifica tu internet e intenta de nuevo.');
            } else {
                showError('‚ùå Error: ' + error);
            }
        }

        function showRateLimitWarning() {
            elements.rateLimitInfo.className = 'rate-limit-info warning';
            elements.rateLimitInfo.innerHTML = '‚ö†Ô∏è <strong>Rate Limit Detectado:</strong> Esperando 5 segundos antes del siguiente intento...';
            
            setTimeout(function() {
                elements.rateLimitInfo.className = 'rate-limit-info success';
                elements.rateLimitInfo.innerHTML = '‚úÖ <strong>Rate Limiting Adaptativo:</strong> Ahora procesando con mayor espaciado para evitar errores 429';
                
                setTimeout(function() {
                    elements.rateLimitInfo.className = 'rate-limit-info';
                    elements.rateLimitInfo.innerHTML = 'üöÄ <strong>Rate Limiting Activo:</strong> Las peticiones se procesan secuencialmente para evitar errores 429';
                }, 3000);
            }, 2000);
        }

        // ===========================
        // DESCARGA
        // ===========================
        function downloadImage() {
            if (!processedImageData) {
                showError('No hay imagen para descargar');
                return;
            }
            
            try {
                var link = document.createElement('a');
                link.download = 'imagen-editada-' + Date.now() + '.jpg';
                link.href = processedImageData;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess('Imagen descargada correctamente');
            } catch (e) {
                showError('Error al descargar: ' + e.message);
            }
        }

        // ===========================
        // MENSAJES Y NOTIFICACIONES
        // ===========================
        function hideApiMessages() {
            var apiNotice = document.getElementById('apiNotice');
            if (apiNotice) {
                apiNotice.style.display = 'none';
            }
        }

        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.style.display = 'block';
            elements.successMessage.style.display = 'none';
            
            setTimeout(function() {
                elements.errorMessage.style.display = 'none';
            }, 7000);
        }

        function showSuccess(message) {
            elements.successMessage.textContent = message;
            elements.successMessage.style.display = 'block';
            elements.errorMessage.style.display = 'none';
            
            setTimeout(function() {
                elements.successMessage.style.display = 'none';
            }, 3000);
        }

        function hideMessages() {
            elements.errorMessage.style.display = 'none';
            elements.successMessage.style.display = 'none';
        }

        // ===========================
        // LOGS DE ESTADO
        // ===========================
        function logFinalStatus() {
            console.log('üìä === REPORTE FINAL DE ELEMENTOS ===');
            console.log('Modo actual:', currentMode);
            console.log('Imagen formato:', formatImageData ? 'Cargada' : 'No cargada');
            console.log('Imagen persona:', personImageData ? 'Cargada' : 'No cargada');
            console.log('Imagen prenda:', garmentImageData ? 'Cargada' : 'No cargada');
            console.log('Imagen procesada:', processedImageData ? 'Lista' : 'No disponible');
            console.log('Cola de peticiones:', requestQueue.length);
            console.log('Delay entre peticiones:', requestDelay + 'ms');
            console.log('Bot√≥n fondo blanco:', elements.btnWhiteBg.disabled ? 'Deshabilitado' : 'Habilitado');
            console.log('Bot√≥n formato cuadrado:', elements.btnSquareFormat.disabled ? 'Deshabilitado' : 'Habilitado');
            console.log('Bot√≥n virtual try-on:', elements.btnVirtualTryOn.disabled ? 'Deshabilitado' : 'Habilitado');
            console.log('Bot√≥n descarga:', elements.downloadBtn.disabled ? 'Deshabilitado' : 'Habilitado');
            console.log('=====================================');
        }
    </script>
</body>
</html>
